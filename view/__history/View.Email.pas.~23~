unit View.Email;

interface

uses
   Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
   System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, IdMessage,
   IdTCPConnection, IdTCPClient, IdExplicitTLSClientServerBase, IdMessageClient,
   IdSMTPBase, IdSMTP, IdBaseComponent, IdComponent, IdIOHandler,
   IdIOHandlerSocket, IdIOHandlerStack, IdSSL, IdSSLOpenSSL, Vcl.StdCtrls,
   Vcl.Buttons, Vcl.ExtCtrls, IdText, IdAttachmentFile;

type
   TEmailView = class(TForm)
      edtRemetente: TLabeledEdit;
      edtDestinatario: TLabeledEdit;
      edtAssunto: TLabeledEdit;
      memTextoEmail: TMemo;
      Label1: TLabel;
      pnlBar: TPanel;
      btnEnviarEmail: TBitBtn;
      lblAnexo: TLabel;
      IdSMTP1: TIdSMTP;
    IdSSLIOHandlerSocketOpenSSL1: TIdSSLIOHandlerSocketOpenSSL;
    edtPassword: TLabeledEdit;
      procedure btnEnviarEmailClick(Sender: TObject);
   private
      function RetornaSMTP(pEmail: String): String;
    { Private declarations }
   public
    { Public declarations }
   end;

var
   EmailView: TEmailView;

implementation

{$R *.dfm}

function TEmailView.RetornaSMTP(pEmail: String): String;
begin
   Result := 'smtp.'+ Copy(pEmail, Pos('@', pEmail) +1, Length(pEmail));
end;

procedure TEmailView.btnEnviarEmailClick(Sender: TObject);
var
   IdText   : TIdText;
   xIdMessage: TIdMessage;
begin
   //CONFIGURAÇÃO SSL
   IdSSLIOHandlerSocketOpenSSL1.SSLOptions.Method := sslvSSLv23;
   IdSSLIOHandlerSocketOpenSSL1.SSLOptions.Mode   := sslmClient;

   //CONFIGURAÇÃO DO SERVIDOR
   XIdSMTP := tI
   IdSMTP1.IOHandler := IdSSLIOHandlerSocketOpenSSL1;
   IdSMTP1.UseTLS    := utUseImplicitTLS;
   IdSMTP1.AuthType  := satDefault;
   IdSMTP1.Host      := RetornaSMTP(edtRemetente.Text);
   IdSMTP1.Port      := 465;
   IdSMTP1.Username  := edtRemetente.Text;
   IdSMTP1.Password  := edtPassword.Text;

   try
      //CONFIGURANDO MENSAGEM
      xIdMessage := TIdMessage.Create(Nil);
      xIdMessage.CharSet      := 'utf-8';
      xIdMessage.Encoding     := meMIME;
      xIdMessage.Priority     := mpNormal;

      //REMETENTE
      xIdMessage.From.Name    := IdSMTP1.Username;
      xIdMessage.From.Address := IdSMTP1.Username;

      //ASSUNTO
      xIdMessage.Subject      := edtAssunto.Text;

      //DESTINATÁRIO
      xIdMessage.Recipients.EMailAddresses := edtDestinatario.Text;

      //CORPO DO E-MAIL
      IdText := TIdText.Create(xIdMessage.MessageParts);
      IdText.ContentType := 'text/html; text/plain; charset=iso-8859-1';
      IdText.Body.Add(memTextoEmail.Text);

      //ANEXO
      TIdAttachmentFile.Create(xIdMessage.MessageParts, 'XML.xml');

      try
         IdSMTP1.Connect;
         IdSMTP1.Authenticate;
         IdSMTP1.Send(xIdMessage);

         MessageDlg('E-mail enviado com sucesso!', mtInformation, [mbOk], 0);
         Close;
      except
         on E: Exception do
            MessageDlg(E.Message, mtWarning, [mbOk], 0);
      end;
   finally
      if xIdMessage <> Nil then
         FreeAndNil(xIdMessage);

      IdSMTP1.Disconnect;
      UnLoadOpenSSLLibrary;
   end;
end;

end.

