unit Util.ViaCEP;

interface

type
   TEndereco = record
      Logradouro: String;
      Complemento: String;
      Bairro: String;
      Localidade: String;
      UF: String;
      Unidade: String;
      IBGE: String;
      GIA: String;
   end;

   TViaCEPUtil = class
   public
      class function GetEndereco(pCEP: String): TEndereco;
   end;

implementation

uses
   System.Classes, System.SysUtils;

{ TViaCEPUtil }

class function TViaCEPUtil.GetEndereco(pCEP: String): TEndereco;
var
   xHTTP: TIdHTTP;
   xIDSSLHandler: TIdSSLIOHandlerSocketOpenSSL;
   Response: TStringStream;
   LJsonObj: TJSONObject;
begin
   try
      xHTTP := TIdHTTP.Create;
      xIDSSLHandler := TIdSSLIOHandlerSocketOpenSSL.Create;
      xHTTP.IOHandler := xIDSSLHandler;
      Response := TStringStream.Create('');
      xHTTP.Get('https://viacep.com.br/ws/' + CEP + '/json', Response);
      if (xHTTP.ResponseCode = 200) and not(Utf8ToAnsi(Response.DataString) = '{'#$A'  "erro": true'#$A'}') then
         Result := TJSONObject.ParseJSONValue(TEncoding.ASCII.GetBytes( Utf8ToAnsi(Response.DataString)), 0) as TJSONObject;
   finally
      FreeAndNil(xHTTP);
      FreeAndNil(xIDSSLHandler);
      Response.Destroy;
   end;
end;

end.
